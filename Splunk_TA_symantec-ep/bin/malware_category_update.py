import os.path as op
import sys
sys.path.insert(0, op.join(op.dirname(op.abspath(__file__)), 'splunktalib'))

from splunktalib.conf_manager import conf_manager as conf
from splunktalib import credentials as cred
from splunktalib.common import log
import splunktalib.rest as rest
import splunktalib.common.util as utils
import splunk.clilib.cli_common as scc
from xml.etree import cElementTree as ET
import csv
import os
import logging
import traceback
import splunk_cluster as sc

utils.remove_http_proxy_env_vars()
logger = log.Logs().get_logger('ta_symantec-ep', level=logging.DEBUG)


def construct_url(base_url):
    url_list = []
    order_list = map(chr, range(65, 91))
    order_list.append('_1234567890')
    for i in order_list:
        url_list.append(base_url+"?azid="+i)
    return url_list


def extract_xml(http, url_list, retry=3):
    item_list = []
    for url in url_list:
        resp, content = None, None
        for _ in range(retry):
            try:
                logger.info("Requesting url:"+url)
                resp, content = http.request(url, 'GET')
            except Exception:
                logger.error("ERROR in requesting url:"+url)
            else:
                if resp.status not in (200, 201):
                    logger.error("Error response."+str(resp.status))
                else:
                    break
        if resp is None and content is None:
            logger.error("Please check the firewall or proxy settings.")
            sys.exit()
        else:
            root = ET.fromstring(content)
            items = root[0].findall('item')
            i_dict = {}
            for item in items:
                i_dict['title'] = item.find('title').text
                i_dict['link'] = item.find('link').text
                i_dict['pubDate'] = item.find('pubDate').text
                s = str(item.find('description').text)
                if "Risk Level" in s:
                    i_dict['riskLevel'] = s[s.find('Risk Level')+11:s.find('.')].lstrip()
                if "Type" in s:
                    i_dict['type'] = s[s.find('Type')+5:s.find('.', s.find('Type')+5)].lstrip()
                item_list.append(dict(i_dict))
    return item_list


def save_lookup_file(file_name, item_list):
    try:
        with open(file_name, 'w') as csv_file:
            fieldnames = ['title', 'link', 'pubDate', 'riskLevel', 'type']
            writer = csv.DictWriter(csv_file, fieldnames=fieldnames, restval='')

            writer.writeheader()
            for item in item_list:
                writer.writerow(item)
    except Exception:
        logger.error("ERROR writing result to csv file.")


def run():
    logger.info("Script input start.")
    logger.info("Start reading session key")
    if sys.stdin.closed:
        return
    session_key = sys.stdin.read()
    logger.info("End reading session key")
    splunkd_uri = scc.getMgmtUri()
    server_info = sc.ServerInfo(splunkd_uri,session_key)
    if not server_info.is_shc_member() or server_info.is_captain():
        logger.info("This is a single instance or cluster captain. Run the malare_category_update.")
        app_name = "Splunk_TA_symantec-ep"
        conf_name = "symantec_ep"
        stanza = "symantec_ep_proxy"
        base_url = "https://www.symantec.com/xml/rss/azlistings.jsp"
        encrypted = "******"    
        conf_manager = conf.ConfManager(splunkd_uri=splunkd_uri, session_key=session_key,
                                        owner='-', app_name=app_name)
        conf_manager.reload_conf(conf_name)
        stanza_obj = conf_manager.get_conf(conf_name, stanza)
        config = {
            "username": "",
            "password": "",
            "proxy_url": "",
            "proxy_port": "",
            "proxy_username": "",
            "proxy_password": "",
            "proxy_type": "",
            "proxy_rdns": "",
        }
        if stanza_obj["proxy_enabled"].lower().strip() in ("1", "true", "yes", "t", "y"):
            config["proxy_url"] = stanza_obj["proxy_url"]
            config["proxy_port"] = int(stanza_obj["proxy_port"])
            config["proxy_type"] = stanza_obj["proxy_type"]
            config["proxy_rdns"] = stanza_obj["proxy_rdns"]
            is_encrypted = all(stanza_obj.get(k, None) == "******" for k in ("proxy_username", "proxy_password"))
            if is_encrypted:
                logger.info("Decrypting")
                cred_mgr = cred.CredentialManager(session_key=session_key,
                                                  app=app_name, splunkd_uri=splunkd_uri)
                user_creds = cred_mgr.get_clear_password("symantec_ep_proxy")
                proxy_username = user_creds["symantec_ep_proxy"]["proxy_username"]
                proxy_password = user_creds["symantec_ep_proxy"]["proxy_password"]
                config["proxy_username"] = proxy_username
                config["proxy_password"] = proxy_password
            else:
                if stanza_obj["proxy_username"] is not None and stanza_obj["proxy_password"] is not None:
                    logger.info("Encrypting")

                    config["proxy_username"] = stanza_obj["proxy_username"]
                    config["proxy_password"] = stanza_obj["proxy_password"]

                    cred_mgr = cred.CredentialManager(session_key=session_key,
                                                      app=app_name, splunkd_uri=splunkd_uri)
                    try:
                        new_stanza = {}
                        proxy = {'proxy_username': config["proxy_username"], 'proxy_password': config["proxy_password"]}
                        new_stanza['symantec_ep_proxy'] = proxy

                        result = cred_mgr.update(new_stanza)
                        logger.info("Update result:"+str(result))

                        proxy_stanza = config.copy()

                        proxy_stanza['proxy_username'] = encrypted
                        proxy_stanza['proxy_password'] = encrypted

                        success = conf_manager.update_stanza('symantec_ep', 'symantec_ep_proxy', proxy_stanza)

                        if not success:
                            logger.error("ERROR in writing symantec_ep conf file.")
                    except Exception:
                        logger.error("ERROR in updating cred stanza")
                        logger.error(traceback.format_exc())

        try:
            try:
                http = rest.build_http_connection(config, timeout=60)
            except Exception:
                logger.error("ERROR in building connection")
                return

            if http is not None:
                url_list = construct_url(base_url)
                item_list = extract_xml(http, url_list)
                file_name = os.path.join(os.environ['SPLUNK_HOME'], 'etc', 'apps',
                                         app_name, 'lookups', 'symantec_ep_malware_categories_tmp.csv')
                save_lookup_file(file_name, item_list)
                logger.info("Start the SPL")
                request_url = splunkd_uri + "/services/search/jobs/export"
                args = {
                    "search": "|inputlookup symantec_ep_malware_category_lookup_tmp "
                          "|append [inputlookup symantec_ep_malware_category_lookup] | dedup title"
                          "|outputlookup symantec_ep_malware_category_lookup",
                    "output_mode": "raw"
                }
                response, _= rest.splunkd_request(splunkd_uri=request_url, data=args, session_key=session_key, method='POST')
                if response.status not in (200, 201):
                    logger.error("The SPL is not executed corretcly.")
                else:
                    logger.info("The SPL is executed correctly.")
            else:
                logger.error("Failed to create http object.")
        except Exception:
            logger.error("ERROR in updating malware category lookup table.")
    else:
        logger.info("This is not the cluster captain. Do not run the malare_category_update.")


if __name__ == "__main__":
    run()
